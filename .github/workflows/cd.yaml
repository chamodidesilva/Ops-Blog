name: CD
on:
    pull_request:
        branches:
            - staging
    push:
        branches: 
            - staging
env:
  IMAGE: ${{ vars.IMAGE }}:${{ github.sha }}
jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Build docker image
              run: docker build -t ${{ env.IMAGE }} .
            - name: Run container
              run: docker run --rm -d -p 5000:5000 --name flask-app ${{ env.IMAGE }}
            - name: Test container
              run: |
                sleep 5
                curl --fail http://localhost:5000/hello 
            - name: Stop container
              run: docker stop flask-app
            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                username: ${{ vars.DOCKERHUB_USERNAME }}
                password: ${{ secrets.DOCKERHUB_TOKEN }}
            - name: Push to Docker Hub
              run: docker push ${{ env.IMAGE }}
    deploy:
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Set up kubectl
              uses: azure/setup-kubectl@v3
              with:
                  version: 'latest'
            - name: Start minikube
              uses: medyagh/setup-minikube@latest
              with:
                driver: docker
            - name: Confirm cluster is running
              run: kubectl get nodes
            - name: Deploy to Minikube
              run: |
                kubectl -f apply k8s/
                kubectl rollout status deployment/flask-app-deployment


